# NCCL Analyser

In distributed deep learning, analyzing the performance of collective communication operations is crucial for diagnosing and optimizing **performance at scale**. **NCCL Analyser** is a Python SDK designed to parse and analyze NCCL kernel events from PyTorch trace files (JSON). It computes key metrics like **communication latency**, **message sizes**, **algorithm bandwidth**, **bus bandwidth**, and **synchronization metrics** (e.g., skew in start/end times), providing insights into communication patterns and potential bottlenecks in your distributed training or inference workflows.


---

## Key Features

<!-- we need to add point about sync metrics skew in start time, another point at the start about the correlation by colelctive id which is then used to correlated events across the ranks -->
- **Detailed NCCL Event Extraction**: Parses JSON trace files to extract per-rank NCCL kernel events (those containing _nccl_ in the kernel name).

- **Correlated Events via Collective ID**: Each collective operation is assigned a unique `collective_id`, generated by combining the **Process Group Name** and an `index_in_group`. The `index_in_group` reflects the order in which that collective appears in the trace.

- **Latency Computation for Implicit-Sync Collectives**: For collectives like allreduce, allgather, reducescatter, and alltoall, the tool computes communication latency by taking the minimum duration across ranks to eliminate waiting time.

- **Bandwidth Analysis**: Computes algorithm bandwidth based on  input msg size and communication latency and finally bus bandwidth (link utilization).

- **Synchronization (Wait-Time) Metrics**: Tracks **skew in start times** (how late certain ranks arrive) and **skew in end times**, providing insights for diagnosing load imbalance or synchronization overheads.

- **Alltoallv Support**: Provides raw data for alltoallv events, which do not enforce an implicit sync pattern.

- **Summary & Detailed Dataframes**: Supports both high-level summaries for quick insights and detailed dataframes for advanced analysis, including per-rank metadata and performance metrics. We suggest **power users** to build their custom pipelines and analyses on top of detailed dfs. 

- **PyTorch Support**: Currently built for PyTorch trace files, with the potential to extend support to other frameworks.

---

## Quick Start

The NcclAnalyser can generate both per collective data frame as well as a global summary. There are more features demonstrated in [example notebook](../examples/nccl_analyser_example.ipynb)
 

### Example: Quick Summary of Implicit Sync Collectives

```python
from TraceLens import NcclAnalyser
import os

# Define the root directory and create file paths for all ranks
root_dir = '/path/to/your/trace/files/directory'
world_size = 8
list_profile_filepaths = [os.path.join(root_dir, f'rank{i}_trace.json') for i in range(world_size)]

# Initialize the NCCL Analyser
my_nccl_analyser = NcclAnalyser(list_profile_filepaths, world_size)

# Generate the summarized dataframe for implicit-sync collectives
df_summary = my_nccl_analyser.build_df_summary_nccl_implicit_sync_cat(agg_metrics=['mean'])
print(df_summary.head())

# Save the summary to CSV
df_summary.to_csv('nccl_summary.csv', index=False)

```
**Summarized Dataframe**: 
- Groups events by collective type, message size, and data type to compute aggregated metrics.
- For communication performance we compute communication latency, algorithm bandwidth, and bus bandwidth. 
- For synchronisation delay we compute metrics like skew in start times which shows the wait time. This is based on the difference of earliest and latest arrival across the ranks for a given collective. 

#### Example Summarized Dataframe

| Collective name      | In msg size (MB) | dtype    | comm latency (µs)_mean | count | Total latency (ms) | algo bw (GB/s)_mean | bus bw (GB/s)_mean | skew in start time (µs)_mean |
|----------------------|------------------|----------|------------------------|-------|---------------------|---------------------|---------------------|-----------------------------|
| _allgather_base      | 204.00           | BFloat16 | 6041.88                | 318   | 1921.32             | 33.00               | 28.88               | 11779.36                     |
| _reduce_scatter_base | 3264.06          | Float    | 11662.77               | 160   | 1866.04             | 273.43              | 239.25              | 60238.77                     |
| _reduce_scatter_base | 8016.03          | Float    | 22988.50               | 2     | 45.98               | 340.53              | 297.96              | 146.48                       |
| _allgather_base      | 501.00           | BFloat16 | 11920.84               | 2     | 23.84               | 41.04               | 35.91               | 15405.14                     |
| allreduce            | 0.00             | Float    | 18.58                  | 6     | 0.11                | 0.00                | 0.00                | 936.63                       |


Note that the last row in msg size is just rounded down to 0. 

**Modify the filepaths for your profiles in nccl_analyser_example.ipynb notebook and get analysis instantly!**
